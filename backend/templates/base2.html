<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style2.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="animation-container">
        <div class="intro-box">
            <h1 id="typewriter">Card Match</h1>
        </div>
        <p class="team-credit">Jay Barrett, Harsh Patel, Maryam Albakry, Ryan King</p>
        <p class="dev-preview">Developer preview</p>
        <p class="skip-hint">Press any key to skip</p>
    </div>

    <div id="app-container" style="display: none;">
        <header>
            <div class="header-content">
                <h1>Card Match</h1>
                <p>Find the perfect credit card for your lifestyle and financial goals</p>
            </div>
        </header>

        <main class="main-content">
            <!-- Changed to a form with method and action -->
            <form method="POST" action="/filter-cards" class="filters-column">
                <h2>Find Your Match</h2>
                
                <div class="filter-item">
                    <label for="credit-score">Credit Score Range</label>
                    <!-- Added name attribute to the select element -->
                    <select id="credit-score" name="credit-score" class="filter-select">
                        <option value="not_relevant" selected>Prefer not to specify</option>
                        <option value="excellent">Excellent (750+)</option>
                        <option value="good">Good (700-749)</option>
                        <option value="fair">Fair (650-699)</option>
                        <option value="poor">Poor (Below 650)</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="preferred-airline">Preferred Airline (if any)</label>
                    <select id="preferred-airline" class="filter-select">
                        <option value="not_relevant" selected>Not relevant</option>
                        <option value="delta">Delta</option>
                        <option value="united">United</option>
                        <option value="american">American</option>
                        <option value="southwest">Southwest</option>
                        <option value="none">None</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="travel-frequency">Travel Frequency</label>
                    <select id="travel-frequency" class="filter-select">
                        <option value="not_relevant" selected>Prefer not to specify</option>
                        <option value="frequent">Frequently (3-5 times/year)</option>
                        <option value="occasional">Occasionally (1-2 times/year)</option>
                        <option value="rare">Rarely (Less than once/year)</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="annual-fee">Willing to Pay Annual Fee?</label>
                    <select id="annual-fee" name="annual-fee" class="filter-select">
                        <option value="no">No annual fee</option>
                        <option value="up-to-100">Yes, up to $100</option>
                        <option value="up-to-250">Yes, up to $250</option>
                        <option value="up-to-500">Yes, up to $500</option>
                        <option value="up-to-700">Yes, up to $700</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label for="description">Tell us what you're looking for</label>
                    <textarea id="description" rows="4" placeholder="I want a credit card for travel and dining"></textarea>
                </div>

                <!-- Changed to type="submit" -->
                <button type="submit" id="find-cards-btn" class="primary-btn">Find My Cards</button>
            </form>

            <div class="results-column" id="results-container">
                <div class="loading-placeholder" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Finding the best matches for you...</p>
                </div>
            </div>
        </main>
        
        <div id="global-reviews-modal" class="reviews-modal">
            <div class="reviews-content">
                <span class="close-reviews" onclick="hideReviews()">&times;</span>
                <h3 id="reviews-card-title">Card Reviews</h3>
                <div id="reviews-container">
                </div>
            </div>
        </div>
        
        <!-- New Match Explanation Modal -->
        <div id="match-explanation-modal" class="reviews-modal">
            <div class="reviews-content explanation-content">
                <span class="close-reviews" onclick="hideExplanation()">&times;</span>
                <h3 id="explanation-card-title">Match Explanation</h3>
                <div id="explanation-container">
                    <div class="explanation-section">
                        <h4>Base Match Metrics</h4>
                        <div id="base-metrics"></div>
                    </div>
                    <div class="explanation-section">
                        <h4>Adjustment Factors</h4>
                        <div id="adjustment-factors"></div>
                    </div>
                    <div class="explanation-section">
                        <h4>Similarity Components</h4>
                        <div id="similarity-components"></div>
                    </div>
                    <div class="explanation-section">
                        <h4>Related Reviews</h4>
                        <div id="related-reviews"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function typeWriterAnimation() {
            const phrases = [
                "Card Match", 
                "Card Match...Visa", 
                "Card Match...Chase", 
                "Card Match...CS4300"
            ];
            
            const typewriterElement = document.getElementById('typewriter');
            let phraseIndex = 0;
            let charIndex = 0;
            let isDeleting = false;
            let typingSpeed = 150;
            
            function type() {
                const currentPhrase = phrases[phraseIndex];
                
                if (isDeleting) {
                    if (charIndex > 10) {
                        typewriterElement.textContent = currentPhrase.substring(0, charIndex - 1);
                        charIndex--;
                        typingSpeed = 75; 
                    } else {
                        isDeleting = false;
                        phraseIndex = (phraseIndex + 1) % phrases.length;
                        typingSpeed = 300; 
                        
                        if (phraseIndex === 0) {
                            setTimeout(completeAnimation, 1000);
                            return;
                        }
                    }
                } else {
                    typewriterElement.textContent = currentPhrase.substring(0, charIndex + 1);
                    charIndex++;
                    typingSpeed = 150;
                    
                    if (charIndex === currentPhrase.length) {
                        typingSpeed = 800; 
                        isDeleting = true;
                    }
                }
                
                setTimeout(type, typingSpeed);
            }
            
            type();
            
            setTimeout(completeAnimation, 25000);
        }
        
        // Function to collect filter values
        function collectFilterValues() {
            return {
                creditScore: document.getElementById('credit-score').value,
                preferredAirline: document.getElementById('preferred-airline').value,
                travelFrequency: document.getElementById('travel-frequency').value,
                annualFee: document.getElementById('annual-fee').value,
                description: document.getElementById('description').value
            };
        }
        
        // Function to transition from animation to main app
        function completeAnimation() {
            const animationContainer = document.getElementById('animation-container');
            const appContainer = document.getElementById('app-container');
            
            animationContainer.style.animation = 'fadeOut 1s forwards';
            
            setTimeout(() => {
                animationContainer.style.display = 'none';
                appContainer.style.display = 'block';
                appContainer.style.animation = 'fadeIn 1s forwards';
            }, 1000);
        }
        
        let currentOffset = 0;
        let currentQuery = '';
        let currentFilters = {};
        let hasMoreResults = false;
        const resultsPerPage = 3;
        const maxResults = 20;
        
        // Function to show reviews modal with specific card data
        function showReviews(cardTitle, reviews) {
            document.getElementById('reviews-card-title').textContent = `Top Reviews for ${cardTitle}`;
            
            const reviewsContainer = document.getElementById('reviews-container');
            reviewsContainer.innerHTML = '';
            
            reviews.forEach(review => {
                const reviewElement = document.createElement('div');
                reviewElement.className = 'review-item';
                reviewElement.innerHTML = `
                    <p>"${review.text}"</p>
                    <p class="review-author">- ${review.author}</p>
                `;
                reviewsContainer.appendChild(reviewElement);
            });
            
            document.getElementById('global-reviews-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function hideReviews() {
            document.getElementById('global-reviews-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Function to render a card result
        function renderCardResult(card, matchPercentage) {
            const cardTitle = card.title || 'Credit Card';
            const annualFee = card.annual_fee || 'N/A';
            const category = card.category || '';
            const foreignFee = card.foreign_transaction_fee_value || 'N/A';
            const offerLink = card.offer_link || '#';
            
            // Inside renderCardResult(card, matchPercentage), replace your existing pointsBadges logic with this:

// dynamically build badges from card fields
            const pointsBadges = [];

            // 1) Reward rate badge
            if (card.reward_rate_string_2018 && card.reward_rate_string_2018 !== "-1") {
                pointsBadges.push(card.reward_rate_string_2018);
            }

            // 2) Annual fee badge
            if (card.annual_fee === "$0") {
                pointsBadges.push("No Annual Fee");
            } else if (card.annual_fee && card.annual_fee !== "N/A") {
                pointsBadges.push(`Annual Fee: ${card.annual_fee}`);
            }

            // 3) Foreign‐transaction fee badge
            if (card.foreign_transaction_fee_value === "0%" || card.foreign_transaction_fee_value === "0.0") {
                pointsBadges.push("No Foreign Transaction Fees");
            } else if (card.foreign_transaction_fee_value && card.foreign_transaction_fee_value !== "-1") {
                pointsBadges.push(`Foreign Transaction Fee: ${card.foreign_transaction_fee_value}`);
            }

            // 4) Intro APR badge
            if (card.intro_apr_check_value && card.intro_apr_check_value !== "None" && card.intro_apr_check_value !== "-1") {
                pointsBadges.push(`Intro APR: ${card.intro_apr_check_value}`);
            }

            if (card.reward_rate_string_2018 && card.reward_rate_string_2018 !== "-1") {
                pointsBadges.push(card.reward_rate_string_2018);
            }
            if (card.intro_apr_check_value && card.intro_apr_check_value!=="None") {
                pointsBadges.push(`Intro APR: ${card.intro_apr_check_value}`);
            }

            // 5) Category‐specific perks
            if (card.category && card.category.includes("travel")) {
                pointsBadges.push("Travel Benefits");
            } else if (card.category && card.category.includes("miles")) {
                pointsBadges.push("Earn Miles");
            } else if (card.category && card.category.includes("cash_back")) {
                pointsBadges.push("Cash Back Rewards");
            }

            // render badges into HTML
            // 1) filter out placeholders and zero‐percent
            // 1) filter out placeholders, zero-percent, and "No Annual Fee"
            let filteredBadges = pointsBadges.filter(badge => {
            if (!badge) return false;
            const t = badge.trim();
            if (
                t === 'N/A' ||
                t === '-1' ||
                t === 'None' ||
                /^0+(\.0+)?%$/.test(t) ||           // drop 0% or 0.00%
                t.toLowerCase() === 'no annual fee' ||
                t == "Intro APR: -1"
            ) {
                return false;
            }
            return true;
            });

            // 2) dedupe
            filteredBadges = [...new Set(filteredBadges)];

            // 3) append " back" to pure-percent badges
            const finalBadges = filteredBadges.map(badge => {
            const m = badge.match(/^(\d+(\.\d+)?)%$/);
            return m ? `${m[1]}% back` : badge;
            });

            // now render
            const badgesHTML = finalBadges
            .map(b => `<span class="benefit-badge">${b}</span>`)
            .join('');



            
            // Get user testimonial from actual reviews if available
            let userTestimonial = "This card has great benefits for everyday use.";
            const cardReviews = [];
            
            if (card.reviews && card.reviews.length > 0) {
                // Use the first review as testimonial
                userTestimonial = card.reviews[0].text;
                
                // Convert reviews to the format expected by showReviews
                card.reviews.forEach(review => {
                    cardReviews.push({
                        text: review.text,
                        author: "Card User"
                    });
                });
            } else {
                // Fallback to default reviews if none are available
                if (cardTitle.includes('Chase') && cardTitle.includes('Sapphire')) {
                    userTestimonial = "This card is perfect for travelers who don't want to pay a premium annual fee. The points are flexible and the travel insurance is excellent.";
                } else if (cardTitle.includes('American Express') && cardTitle.includes('Gold')) {
                    userTestimonial = "Great for foodies and anyone who spends a lot on groceries. The dining credits make the annual fee easier to justify.";
                }
                
                cardReviews.push(
                    {
                        text: userTestimonial,
                        author: "Credit Card Enthusiast"
                    },
                    {
                        text: "This card offers exceptional value for its category. The rewards structure aligns perfectly with my spending habits.",
                        author: "Financial Advisor"
                    },
                    {
                        text: "I've had this card for two years and the customer service has been outstanding. The mobile app makes tracking rewards easy.",
                        author: "Loyal Cardholder"
                    }
                );
            }
            
            let issuer = 'Major Bank';
            if (cardTitle.includes('Chase')) {
                issuer = 'Chase Bank';
            } else if (cardTitle.includes('American Express')) {
                issuer = 'American Express';
            } else if (cardTitle.includes('Capital One')) {
                issuer = 'Capital One';
            } else if (cardTitle.includes('Citi')) {
                issuer = 'Citibank';
            } else if (cardTitle.includes('Discover')) {
                issuer = 'Discover';
            }
            
            const rawBonus = card.bonus_offer_value;
            let welcomeBonus;
            if (rawBonus !== undefined && rawBonus.trim() !== '' && rawBonus != "None." && rawBonus != "Nones." && rawBonus != "---MANUALLY FILL IN---." && rawBonus != "--MANUALLY FILL IN--.") {
                welcomeBonus = rawBonus;
            } else {
                welcomeBonus = 'No bonus offer available';
            }

            
            return `
                <div class="card-result">
                    <div class="card-header">
                        <div class="card-info">
                            <h3 class="card-title">
                                <a href="${offerLink}" target="_blank" class="card-link">${cardTitle}</a>
                            </h3>
                            <p class="card-issuer">${issuer}</p>
                            <button class="view-explanation-btn" onclick="showExplanation(${JSON.stringify(card).replace(/"/g, '&quot;')})">See Why We Matched You!</button>
                        </div>
                        <div class="card-image-container">
                            <img src="${card.image_url || 'https://via.placeholder.com/200x125/e8f0fe/1a73e8?text=Card+Image'}" 
                                alt="${cardTitle}" 
                                class="card-image"
                                onerror="this.src='https://via.placeholder.com/200x125/e8f0fe/1a73e8?text=Card+Image'">
                            <div class="image-match-percentage">${matchPercentage}% Match</div>
                        </div>
                    </div>
                    
                    <div class="card-details">
                        <p class="annual-fee">Annual Fee: ${annualFee}</p>
                        
                        <div class="benefits-badges">
                            ${badgesHTML}
                        </div>
                        
                        <div class="welcome-bonus">
                            <h4>Welcome Bonus:</h4>
                            <p>${welcomeBonus}</p>
                        </div>
                        
                        <div class="user-testimonial">
                            <p><em>What Users Say: "${userTestimonial}"</em></p>
                            <button class="view-reviews-btn" onclick="showReviews('${cardTitle}', ${JSON.stringify(cardReviews).replace(/"/g, '&quot;')})">View All Reviews</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Function to load more results
        function loadMoreResults() {
            const loadMoreBtn = document.getElementById('load-more-btn');
            loadMoreBtn.textContent = 'Loading...';
            loadMoreBtn.disabled = true;
            
            currentOffset += resultsPerPage;
            
            fetch("/recommend", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    query: currentQuery,
                    offset: currentOffset,
                    limit: resultsPerPage,
                    filters: currentFilters
                })
            })
            .then(response => response.json())
            .then(data => {
                loadMoreBtn.textContent = 'See More Results';
                loadMoreBtn.disabled = false;
                
                if (data.recommendations && data.recommendations.length > 0) {
                    const resultsContainer = document.getElementById('results-container');
                    const loadMoreContainer = document.getElementById('load-more-container');
                    
                    data.recommendations.forEach((card, index) => {
                        if (!card.offer_link) {
                            if (card.title.includes('Chase')) {
                                card.offer_link = 'https://creditcards.chase.com/';
                            } else if (card.title.includes('American Express')) {
                                card.offer_link = 'https://www.americanexpress.com/';
                            } else if (card.title.includes('Capital One')) {
                                card.offer_link = 'https://www.capitalone.com/credit-cards/';
                            } else if (card.title.includes('Citi')) {
                                card.offer_link = 'https://www.citi.com/credit-cards/';
                            } else if (card.title.includes('Discover')) {
                                card.offer_link = 'https://www.discover.com/credit-cards/';
                            } else {
                                card.offer_link = 'https://www.nerdwallet.com/credit-cards';
                            }
                        }
                        
                        const matchPercentage = card.match_percentage;
                        
                        const cardElement = document.createElement('div');
                        cardElement.innerHTML = renderCardResult(card, matchPercentage);
                        
                        resultsContainer.insertBefore(cardElement, loadMoreContainer);
                    });
                    
                    hasMoreResults = data.pagination.has_more;
                    
                    if (!hasMoreResults || currentOffset + resultsPerPage >= maxResults) {
                        loadMoreBtn.style.display = 'none';
                        
                        const noMoreText = document.createElement('p');
                        noMoreText.className = 'no-more-cards';
                        noMoreText.textContent = 'No more cards available';
                        loadMoreContainer.appendChild(noMoreText);
                    }
                } else {
                    hasMoreResults = false;
                    
                    const loadMoreContainer = document.getElementById('load-more-container');
                    loadMoreBtn.style.display = 'none';
                    
                    const noMoreText = document.createElement('p');
                    noMoreText.className = 'no-more-cards';
                    noMoreText.textContent = 'No more cards available';
                    loadMoreContainer.appendChild(noMoreText);
                }
            })
            .catch(error => {
                console.error('Error fetching more recommendations:', error);
                loadMoreBtn.textContent = 'See More Results';
                loadMoreBtn.disabled = false;
                
                const errorText = document.createElement('p');
                errorText.className = 'error-message';
                errorText.textContent = 'Error loading more results. Please try again.';
                document.getElementById('load-more-container').appendChild(errorText);
            });
        }
        
        // Function to get card recommendations - this was missing!
        function getCardRecommendations() {
            const filterValues = collectFilterValues();
            currentQuery = filterValues.description;
            currentFilters = {
                creditScore: filterValues.creditScore,
                preferredAirline: filterValues.preferredAirline,
                travelFrequency: filterValues.travelFrequency,
                annualFee: filterValues.annualFee
            };
            
            currentOffset = 0;
            
            const loadingElement = document.querySelector('.loading-placeholder');
            const loadingClone = loadingElement ? loadingElement.cloneNode(true) : null;
            
            const resultsContainer = document.getElementById('results-container');
            
            resultsContainer.innerHTML = '';
            
            if (loadingClone) {
                loadingClone.style.display = 'flex';
                resultsContainer.appendChild(loadingClone);
            }
            
            console.log("Making request with query:", currentQuery);
            console.log("Filters:", currentFilters);
            
            fetch("/recommend", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    query: currentQuery,
                    offset: currentOffset,
                    limit: resultsPerPage,
                    filters: currentFilters
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Got response:", data);
                
                if (data.recommendations && data.recommendations.length > 0) {
                    console.log("First card details:", {
                        title: data.recommendations[0].title,
                        match_percentage: data.recommendations[0].match_percentage,
                        similarity_score: data.recommendations[0].similarity_score
                    });
                }
                
                resultsContainer.innerHTML = '';
                
                if (data.recommendations && data.recommendations.length > 0) {
                    hasMoreResults = data.pagination.has_more;
                    
                    data.recommendations.forEach((card, index) => {
                        if (!card.offer_link) {
                            if (card.title.includes('Chase')) {
                                card.offer_link = 'https://creditcards.chase.com/';
                            } else if (card.title.includes('American Express')) {
                                card.offer_link = 'https://www.americanexpress.com/';
                            } else if (card.title.includes('Capital One')) {
                                card.offer_link = 'https://www.capitalone.com/credit-cards/';
                            } else if (card.title.includes('Citi')) {
                                card.offer_link = 'https://www.citi.com/credit-cards/';
                            } else if (card.title.includes('Discover')) {
                                card.offer_link = 'https://www.discover.com/credit-cards/';
                            } else {
                                card.offer_link = 'https://www.nerdwallet.com/credit-cards';
                            }
                        }
                        
                        const matchPercentage = card.match_percentage;
                        
                        const cardElement = document.createElement('div');
                        cardElement.innerHTML = renderCardResult(card, matchPercentage);
                        resultsContainer.appendChild(cardElement);
                    });
                    
                    const loadMoreContainer = document.createElement('div');
                    loadMoreContainer.id = 'load-more-container';
                    loadMoreContainer.className = 'load-more-container';
                    
                    if (hasMoreResults && currentOffset + resultsPerPage < maxResults) {
                        loadMoreContainer.innerHTML = `
                            <button id="load-more-btn" class="load-more-btn">
                                See More Results
                            </button>
                        `;
                    } else {
                        loadMoreContainer.innerHTML = `
                            <p class="no-more-cards">No more cards available</p>
                        `;
                    }
                    
                    resultsContainer.appendChild(loadMoreContainer);
                    
                    const loadMoreBtn = document.getElementById('load-more-btn');
                    if (loadMoreBtn) {
                        loadMoreBtn.addEventListener('click', loadMoreResults);
                    }
                } else {
                    resultsContainer.innerHTML = '<p class="no-results">No matching cards found. Try adjusting your criteria.</p>';
                }
            })
            .catch(error => {
                console.error('Error fetching recommendations:', error);
                resultsContainer.innerHTML = '<p class="error-message">An error occurred while fetching recommendations. Please try again.</p>';
            });
        }

        function scrollToTop() {
            window.scrollTo({
            top: 0,
            behavior: 'smooth'
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            typeWriterAnimation();
            
            // Prevent the default form submission and use our custom logic
            document.querySelector('form').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent the default form submission
                
                // Log the selected credit score
                const creditScore = document.getElementById('credit-score').value;
                console.log("Selected Credit Score:", creditScore);
                
                // Use our existing AJAX flow
                getCardRecommendations();

                scrollToTop();
            });
            
            document.getElementById('description').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    getCardRecommendations();
                }
            });
            
            document.getElementById('global-reviews-modal').addEventListener('click', function(event) {
                if (event.target === this) {
                    hideReviews();
                }
            });
            
            document.getElementById('match-explanation-modal').addEventListener('click', function(event) {
                if (event.target === this) {
                    hideExplanation();
                }
            });
            
            document.addEventListener('keydown', function() {
                const animationContainer = document.getElementById('animation-container');
                if (animationContainer.style.display !== 'none') {
                    completeAnimation();
                }
            });
        });
        
        // Function to show match explanation
        function showExplanation(card) {
            document.getElementById('explanation-card-title').textContent = `Match Explanation for ${card.title}`;
            
            // Base metrics
            const baseMetrics = document.getElementById('base-metrics');
            const matchPercentage = card.match_percentage;
            const metrics = card.detailed_metrics;
            
            // Determine if any multipliers were applied
            let multipliers = [];
            const travelFrequency = document.getElementById('travel-frequency').value;
            const preferredAirline = document.getElementById('preferred-airline').value;
            
            // Track if we've already added an airline multiplier to avoid duplicates
            let airlineMultiplierAdded = false;
            
            if (card.match_factors && card.match_factors.length > 0) {
                card.match_factors.forEach(factor => {
                    // For factors with percentage impact values
                    if (factor.impact && (factor.impact.startsWith('+') || factor.impact.startsWith('-'))) {
                        // Handle travel frequency multipliers
                        if (factor.factor.includes("travel") || factor.factor.includes("Travel")) {
                            // Only add if travel frequency is selected
                            if (travelFrequency !== "not_relevant") {
                                let multiplierClass = "neutral-multiplier";
                                if (factor.factor.includes("ideal")) {
                                    multiplierClass = "positive-multiplier";
                                }
                                
                                multipliers.push({
                                    factor: factor.factor,
                                    multiplier: ((parseFloat(factor.impact.replace('%', '').replace('+', '')) / 100) + 1).toFixed(2) + 'x',
                                    impact: factor.impact,
                                    cssClass: multiplierClass
                                });
                            }
                        }
                        // Handle airline multipliers
                        else if (factor.factor.includes("airline") && !airlineMultiplierAdded) {
                            airlineMultiplierAdded = true; // Prevent duplicates
                            
                            const isPreferredAirline = factor.factor.toLowerCase().includes(preferredAirline.toLowerCase()) &&
                                                       preferredAirline !== "not_relevant" && 
                                                       preferredAirline !== "none";
                            
                            // Set different classes for preferred vs general airline match
                            const multiplierClass = isPreferredAirline ? "preferred-airline-multiplier" : "general-airline-multiplier";
                            
                            multipliers.push({
                                factor: factor.factor,
                                multiplier: ((parseFloat(factor.impact.replace('%', '').replace('+', '')) / 100) + 1).toFixed(2) + 'x',
                                impact: factor.impact,
                                cssClass: multiplierClass
                            });
                        }
                        // Handle other percentage-based multipliers
                        else {
                            multipliers.push({
                                factor: factor.factor,
                                multiplier: ((parseFloat(factor.impact.replace('%', '').replace('+', '')) / 100) + 1).toFixed(2) + 'x',
                                impact: factor.impact,
                                cssClass: "neutral-multiplier"
                            });
                        }
                    }
                    // Skip handling text-based impacts to avoid duplicate multipliers
                });
            }
            
            // If no multipliers, add a base placeholder
            if (multipliers.length === 0) {
                multipliers.push({
                    factor: "Base score - no adjustments applied",
                    multiplier: "1.00x",
                    impact: "0%",
                    cssClass: "neutral-multiplier"
                });
            }
            
            // Create the multipliers HTML
            let multipliersHTML = '<div class="multipliers-section">';
            multipliers.forEach(m => {
                multipliersHTML += `
                    <div class="multiplier-item ${m.cssClass}">
                        <div class="multiplier-value">${m.multiplier}</div>
                        <div class="multiplier-factor">${m.factor}</div>
                    </div>
                `;
            });
            multipliersHTML += '</div>';
            
            baseMetrics.innerHTML = `
                <div class="metric-grid">
                    <div class="metric-item">
                        <span class="metric-label">Final Match:</span>
                        <span class="metric-value">${matchPercentage}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Base Similarity:</span>
                        <span class="metric-value">${(metrics.combined_similarity * 100).toFixed(4)}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Description Similarity:</span>
                        <span class="metric-value">${(metrics.description_similarity * 100).toFixed(4)}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Review Similarity:</span>
                        <span class="metric-value">${(metrics.review_similarity * 100).toFixed(4)}%</span>
                    </div>
                </div>
                
                <h4 class="multipliers-heading">Applied Multipliers</h4>
                ${multipliersHTML}
                
                <div class="explanation-formula">
                    <p>Base Score = (${metrics.description_weight} × Description Similarity) + (${metrics.review_weight} × Review Similarity)</p>
                    <p>Base Score = (${metrics.description_weight} × ${(metrics.description_similarity * 100).toFixed(4)}%) + (${metrics.review_weight} × ${(metrics.review_similarity * 100).toFixed(4)}%)</p>
                    <p>Base Score = ${(metrics.combined_similarity * 100).toFixed(4)}%</p>
                </div>
            `;
            
            // Adjustment factors - show the top 3 primary match factors
            const adjustmentFactors = document.getElementById('adjustment-factors');
            let allFactors = [];
            
            // Collect all match factors
            if (card.match_factors && card.match_factors.length > 0) {
                allFactors = [...card.match_factors];
            }
            
            // Add keyword matches as factors if not already present
            const userInput = document.getElementById('description').value.toLowerCase();
            const cardDesc = card.category + " " + (card.annual_fee || "") + " " + (card.reward_rate_string_2018 || "");
            const wordsToExclude = ["credit", "card", "want"];
            const userTokens = userInput.split(/\s+/).filter(token => 
                token.length > 3 && !wordsToExclude.includes(token.toLowerCase())
            );
            
            let keywordMatches = [];
            userTokens.forEach(token => {
                if (cardDesc.toLowerCase().includes(token)) {
                    keywordMatches.push(token);
                }
            });
            
            if (keywordMatches.length > 0 && !allFactors.some(f => f.factor.startsWith("Keyword match"))) {
                allFactors.push({
                    factor: "Keyword match: " + keywordMatches.slice(0, 3).join(", "),
                    impact: "Primary match factor"
                });
            }
            
            // Sort factors by type (prioritize keyword and category matches)
            allFactors.sort((a, b) => {
                const aIsPrimary = a.factor.startsWith("Keyword") || a.factor.startsWith("Category");
                const bIsPrimary = b.factor.startsWith("Keyword") || b.factor.startsWith("Category");
                
                if (aIsPrimary && !bIsPrimary) return -1;
                if (!aIsPrimary && bIsPrimary) return 1;
                return 0;
            });
            
            // Take top 3 factors
            const topFactors = allFactors.slice(0, 3);
            
            if (topFactors.length > 0) {
                let factorsHtml = '<div class="factors-grid">';
                topFactors.forEach((factor, index) => {
                    factorsHtml += `
                        <div class="factor-item ${index < 3 ? 'top-factor' : ''}">
                            <span class="factor-name">${factor.factor}</span>
                            <span class="factor-impact">${factor.impact}</span>
                        </div>
                    `;
                });
                factorsHtml += '</div>';
                adjustmentFactors.innerHTML = factorsHtml;
            } else {
                adjustmentFactors.innerHTML = '<p class="no-factors">No adjustment factors applied</p>';
            }
            
            // Similarity components
            const similarityComponents = document.getElementById('similarity-components');
            similarityComponents.innerHTML = `
                <div class="components-info">
                    <p><strong>SVD Dimensions:</strong> ${metrics.svd_dimensions}</p>
                    <p><strong>Text Processing:</strong> TF-IDF Vectorization + SVD Dimensionality Reduction</p>
                    <p><strong>Similarity Measure:</strong> Cosine Similarity</p>
                </div>
                <div class="weight-visualization">
                    <div class="weight-bar">
                        <div class="weight-segment description-weight" style="width: ${metrics.description_weight * 100}%">
                            <span>Description (${metrics.description_weight * 100}%)</span>
                        </div>
                        <div class="weight-segment review-weight" style="width: ${metrics.review_weight * 100}%">
                            <span>Reviews (${metrics.review_weight * 100}%)</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Related reviews with highlighted matching words
            const relatedReviews = document.getElementById('related-reviews');
            if (metrics.top_review_scores && metrics.top_review_scores.length > 0) {
                let reviewsHtml = '<div class="reviews-grid">';
                
                // Get the user's query to highlight matching words
                const userQuery = document.getElementById('description').value;
                const wordsToExclude = ["credit", "card", "want"];
                const significantWords = userQuery.toLowerCase().split(/\s+/).filter(word => 
                    word.length > 3 && !wordsToExclude.includes(word.toLowerCase())
                );
                
                metrics.top_review_scores.forEach((review, index) => {
                    let highlightedText = review.text;
                    
                    // Highlight significant words in the review
                    significantWords.forEach(word => {
                        const regex = new RegExp('\\b(' + word + ')\\b', 'gi');
                        highlightedText = highlightedText.replace(regex, '<strong>$1</strong>');
                    });
                    
                    reviewsHtml += `
                        <div class="review-score-item">
                            <div class="review-header">
                                <span class="review-number">Review #${index + 1}</span>
                                <span class="review-score">Similarity: ${(review.score * 100).toFixed(4)}%</span>
                            </div>
                            <p class="review-text">"${highlightedText}"</p>
                        </div>
                    `;
                });
                reviewsHtml += '</div>';
                relatedReviews.innerHTML = reviewsHtml;
            } else {
                relatedReviews.innerHTML = '<p class="no-reviews">No related reviews available</p>';
            }
            
            document.getElementById('match-explanation-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function hideExplanation() {
            document.getElementById('match-explanation-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>